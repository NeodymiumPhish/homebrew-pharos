name: Update Cask

on:
  repository_dispatch:
    types: [release-published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to update to (without v prefix)'
        required: true

jobs:
  update-cask:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version and update cask
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${{ github.event.client_payload.version }}"
          fi
          
          echo "Updating to version $VERSION"
          
          # Download the DMG to compute SHA256
          DMG_URL="https://github.com/NeodymiumPhish/Pharos/releases/download/v${VERSION}/Pharos_${VERSION}_aarch64.dmg"
          curl -L -o pharos.dmg "$DMG_URL"
          SHA256=$(shasum -a 256 pharos.dmg | cut -d ' ' -f 1)
          rm pharos.dmg
          
          echo "SHA256: $SHA256"
          
          # Update pharos.rb
          cat > Casks/pharos.rb << EOF
          cask "pharos" do
            version "$VERSION"
            sha256 "$SHA256"

            url "https://github.com/NeodymiumPhish/Pharos/releases/download/v#{version}/Pharos_#{version}_aarch64.dmg"
            name "Pharos"
            desc "High-performance PostgreSQL client with modern UI"
            homepage "https://github.com/NeodymiumPhish/Pharos"

            app "Pharos.app"

            postflight do
              system_command "/usr/bin/xattr",
                             args: ["-c", "-r", "#{appdir}/Pharos.app"],
                             sudo: false
            end

            caveats <<~EOS
              This app is not signed. If macOS blocks it, run:
                xattr -d com.apple.quarantine /Applications/Pharos.app
            EOS

            zap trash: [
              "~/Library/Application Support/com.pharos.client",
              "~/Library/Caches/com.pharos.client",
            ]
          end
          EOF

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/pharos.rb
          git commit -m "Update pharos to $VERSION" || exit 0
          git push
