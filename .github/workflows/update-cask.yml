name: Update Cask

on:
  repository_dispatch:
    types: [release-published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to update to (without v prefix)'
        required: true

jobs:
  update-cask:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.HOMEBREW_PAT }}

      - name: Get version and update cask
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${{ github.event.client_payload.version }}"
          fi

          echo "Updating to version $VERSION"

          # Download both DMGs and compute SHA256
          ARM_URL="https://github.com/NeodymiumPhish/Pharos/releases/download/v${VERSION}/Pharos_${VERSION}_arm64.dmg"
          X64_URL="https://github.com/NeodymiumPhish/Pharos/releases/download/v${VERSION}/Pharos_${VERSION}_x64.dmg"

          curl -L -o pharos_arm64.dmg "$ARM_URL"
          curl -L -o pharos_x64.dmg "$X64_URL"

          SHA256_ARM=$(shasum -a 256 pharos_arm64.dmg | cut -d ' ' -f 1)
          SHA256_X64=$(shasum -a 256 pharos_x64.dmg | cut -d ' ' -f 1)
          rm pharos_arm64.dmg pharos_x64.dmg

          echo "ARM64 SHA256: $SHA256_ARM"
          echo "x64 SHA256: $SHA256_X64"

          # Update pharos.rb
          cat > Casks/pharos.rb << EOF
          cask "pharos" do
            arch arm: "arm64", intel: "x64"

            version "$VERSION"

            on_arm do
              sha256 "$SHA256_ARM"
            end
            on_intel do
              sha256 "$SHA256_X64"
            end

            url "https://github.com/NeodymiumPhish/Pharos/releases/download/v#{version}/Pharos_#{version}_#{arch}.dmg"
            name "Pharos"
            desc "High-performance PostgreSQL client with modern UI"
            homepage "https://github.com/NeodymiumPhish/Pharos"

            app "Pharos.app"

            postflight do
              system_command "/usr/bin/xattr",
                             args: ["-c", "-r", "#{appdir}/Pharos.app"],
                             sudo: false
            end

            caveats <<~EOS
              This app is not signed. If macOS blocks it, run:
                xattr -d com.apple.quarantine /Applications/Pharos.app
            EOS

            zap trash: [
              "~/Library/Application Support/com.pharos.client",
              "~/Library/Caches/com.pharos.client",
            ]
          end
          EOF

      - name: Commit and push
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${{ github.event.client_payload.version }}"
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/pharos.rb
          git commit -m "Update pharos to $VERSION" || exit 0
          git push
